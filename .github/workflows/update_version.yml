name: Update Version

on:
  push:
    branches:
      - main

jobs:
  increment_version:
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Increment version
      run: |
        version=$(grep -oP 'version\s*=\s*"\K[^"]+' omnibridge/version.py)
          IFS="." read -ra version_parts <<< "$version"
          patch=$(( ${version_parts[2]} + 1 ))
          new_version="${version_parts[0]}.${version_parts[1]}.$patch"
          sed -i "s/version = \"${version}\"/version = \"${new_version}\"/" omnibridge/version.py
    - name: Commit and push changes
      run: |
          git config user.name "pypi publish workflow"
          git config user.email "your.email@example.com"
          git add omnibridge/version.py
          git commit -m "bump version"
          git push

    - name: Push changes
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: update-version

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "Increment version"
        body: "This PR increments the version in `version.py`."
        branch: update-version
        labels: "version-update"
